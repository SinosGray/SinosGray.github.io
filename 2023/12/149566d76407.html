<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>为什么这么设计 | Sinos_wei's blog</title><meta name="author" content="Sinos"><meta name="copyright" content="Sinos"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="https:&#x2F;&#x2F;draveness.me&#x2F;whys-the-design&#x2F; 为什么设计系列文章总结">
<meta property="og:type" content="article">
<meta property="og:title" content="为什么这么设计">
<meta property="og:url" content="https://sinos_wei.gitee.io/2023/12/149566d76407.html">
<meta property="og:site_name" content="Sinos_wei&#39;s blog">
<meta property="og:description" content="https:&#x2F;&#x2F;draveness.me&#x2F;whys-the-design&#x2F; 为什么设计系列文章总结">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://sinos_wei.gitee.io/img/cover/00000123.jpg">
<meta property="article:published_time" content="2023-12-28T00:20:55.000Z">
<meta property="article:modified_time" content="2024-01-28T12:55:10.433Z">
<meta property="article:author" content="Sinos">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sinos_wei.gitee.io/img/cover/00000123.jpg"><link rel="shortcut icon" href="/img/avatar.jpeg"><link rel="canonical" href="https://sinos_wei.gitee.io/2023/12/149566d76407.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?aeddd8219bc5c1e1efdcf5d9cc3218e6";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '为什么这么设计',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-01-28 20:55:10'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">59</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">177</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">7</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/cover/00000123.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Sinos_wei's blog"><span class="site-name">Sinos_wei's blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">为什么这么设计</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon fas fa-history"></i><span class="post-meta-label">Updated</span><time datetime="2024-01-28T12:55:10.433Z" title="Updated 2024-01-28 20:55:10">2024-01-28</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="为什么这么设计"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>https://draveness.me/whys-the-design/</p>
<p>为什么设计系列文章总结</p>
</blockquote>
<span id="more"></span>
<h1 id="为什么-tcp-建立连接需要三次握手">为什么 TCP 建立连接需要三次握手</h1>
<p>什么是连接: The reliability and flow control mechanisms described above require that TCPs initialize and maintain certain status information for each data stream. The combination of this information, including sockets, sequence numbers, and window sizes, is called a connection.</p>
<p>主要原因: 阻止历史的重复连接初始化 使用三次握手和 <code>RST</code> 控制消息(Reset the connection)将是否建立连接的最终控制权交给了发送方，因为只有发送方有足够的上下文来判断当前连接是否是错误的或者过期的，这也是 TCP 使用三次握手建立连接的最主要原因。</p>
<ul>
<li>『两次握手』：无法避免历史错误连接的初始化，浪费接收方的资源； 想象一下这个场景，如果通信双方的通信次数只有两次，那么发送方一旦发出建立连接的请求之后它就没有办法撤回这一次请求，如果在网络状况复杂或者较差的网络中，发送方连续发送多次建立连接的请求，<strong>如果 TCP 建立连接只能通信两次，那么接收方只能选择接受或者拒绝发送方发起的请求</strong>，它并不清楚这一次请求是不是由于网络拥堵而早早过期的连接。 三次握手由发起方判断是否是历史连接</li>
<li>『四次握手』：TCP 协议的设计可以让我们同时传递 <code>ACK</code> 和 <code>SYN</code> 两个控制信息，减少了通信次数，所以不需要使用更多的通信次数传输相同的信息；</li>
</ul>
<h1 id="为什么使用通信来共享内存">为什么使用通信来共享内存</h1>
<p>『不要通过共享内存来通信，我们应该使用通信来共享内存』，这是一句使用 Go 语言编程的人经常能听到的观点</p>
<ol type="1">
<li>首先，使用发送消息来同步信息相比于直接使用共享内存和互斥锁是一种更高级的抽象，使用更高级的抽象能够为我们在程序设计上提供更好的封装，让程序的逻辑更加清晰；</li>
<li>其次，消息发送在解耦方面与共享内存相比也有一定优势，我们可以将线程的职责分成生产者和消费者，并通过消息传递的方式将它们解耦，不需要再依赖共享内存；</li>
<li>最后，Go 语言选择消息发送的方式，通过保证同一时间只有一个活跃的线程能够访问数据，能够从设计上天然地避免线程竞争和数据冲突的问题；</li>
</ol>
<h1 id="为什么-redis-选择单线程模型">为什么 Redis 选择单线程模型</h1>
<ol type="1">
<li>使用单线程模型能带来更好的可维护性，方便开发和调试；</li>
<li>使用单线程模型也能并发的处理客户端的请求；I/O 多路复用机制</li>
<li>Redis 服务中运行的绝大多数操作的性能瓶颈都不是 CPU；</li>
</ol>
<h1 id="为什么-dns-使用-udp-协议">为什么 DNS 使用 UDP 协议</h1>
<p>为什么 DNS 会使用 UDP 传输数据』以及『为什么 DNS 不止会使用 UDP 传输数据』两个问题</p>
<ol type="1">
<li>DNS 在设计之初就在区域传输中引入了 TCP 协议，在查询中使用 UDP 协议；</li>
<li>当 DNS 超过了 512 字节的限制，我们第一次在 DNS 协议中明确了『当 DNS 查询被截断时，应该使用 TCP 协议进行重试』这一规范；</li>
<li>随后引入的 EDNS 机制允许我们使用 UDP 最多传输 4096 字节的数据，但是由于 MTU 的限制导致的数据分片以及丢失，使得这一特性不够可靠；</li>
<li>在最近的几年，我们重新规定了 DNS 应该同时支持 UDP 和 TCP 协议，TCP 协议也不再只是重试时的选择；</li>
</ol>
<h1 id="udp-与-mtu">udp 与 mtu</h1>
<p>当我们发送的UDP数据大于1472的时候会怎样呢？ 这也就是说IP数据报大于1500字节,大于MTU.这个时候发送方IP层就需要分片(fragmentation). 把数据报分成若干片,使每一片都小于MTU.而接收方IP层则需要进行数据报的重组. 这样就会多做许多事情,而更严重的是,由于UDP的特性,<strong>当某一片数据传送中丢失时,接收方便</strong> <strong>无法重组数据报.将导致丢弃整个UDP数据报。</strong></p>
<p>因此,在普通的局域网环境下，我建议将UDP的数据控制在1472字节以下为好.</p>
<h1 id="为什么需要无意义-id">为什么需要无意义 id</h1>
<p>因为 id 有实际意义会导致可用位变少</p>
<h1 id="为什么-mysql-使用-b-树">为什么 MySQL 使用 B+ 树</h1>
<h1 id="为什么-mongodb-使用-b-树">为什么 MongoDB 使用 B 树</h1>
<h1 id="为什么-tcp-协议有性能问题">为什么 TCP 协议有性能问题</h1>
<ul>
<li>TCP 的拥塞控制算法会在丢包时主动降低吞吐量；</li>
<li>TCP 的三次握手增加了数据传输的延迟和额外开销；</li>
<li>TCP 的累计应答机制导致了数据段的传输；</li>
</ul>
<h1 id="tcp-和-udp-可以同时绑定相同的端口吗">TCP 和 UDP 可以同时绑定相同的端口吗？</h1>
<p>传输层有两个传输协议分别是 TCP 和 UDP，在内核中是两个完全独立的软件模块。</p>
<p>当主机收到数据包后，可以在 IP 包头的「协议号」字段知道该数据包是 TCP/UDP，所以可以根据这个信息确定送给哪个模块（TCP/UDP）处理，送给 TCP/UDP 模块的报文根据「端口号」确定送给哪个应用程序处理。</p>
<p>因此， TCP/UDP 各自的端口号也相互独立，如 TCP 有一个 80 号端口，UDP 也可以有一个 80 号端口，二者并不冲突。</p>
<p>两个 tcp 服务不能绑定同一个端口, 但是，因为只要客户端连接的服务器不同，端口资源可以重复使用的。</p>
<p><img src="https://raw.githubusercontent.com/SinosGray/picgo/master/test/202312281414176.jpg" alt="图片" style="zoom:50%;" /></p>
<p>tcp 快启:</p>
<h3 id="请求fast-open-cookie">请求Fast Open Cookie</h3>
<ol type="1">
<li>客户端发送SYN数据包，该数据包包含Fast Open选项，且该选项的Cookie为空，这表明客户端请求Fast Open Cookie；</li>
<li>支持TCP Fast Open的服务器生成Cookie，并将其置于SYN-ACK数据包中的Fast Open选项以发回客户端；</li>
<li>客户端收到SYN-ACK后，缓存Fast Open选项中的Cookie。</li>
</ol>
<h3 id="实施tcp-fast-open">实施TCP Fast Open</h3>
<p>以下描述假定客户端在此前的TCP连接中已完成请求Fast Open Cookie的过程并存有有效的Fast Open Cookie。</p>
<ol type="1">
<li>客户端发送SYN数据包，该数据包包含数据（对于非TFO的普通TCP握手过程，SYN数据包中不包含数据）以及此前记录的Cookie；</li>
<li>支持TCP Fast Open的服务器会对收到Cookie进行校验：如果Cookie有效，服务器将在SYN-ACK数据包中对SYN和数据进行确认（Acknowledgement），服务器随后将数据递送至相应的应用程序；否则，服务器将丢弃SYN数据包中包含的数据，且其随后发出的SYN-ACK数据包将仅确认（Acknowledgement）SYN的对应序列号；</li>
<li><strong>如果服务器接受了SYN数据包中的数据，服务器可在握手完成之前发送数据；</strong></li>
<li>客户端将发送ACK确认服务器发回的SYN以及数据，但如果客户端在初始的SYN数据包中发送的数据未被确认，则客户端将重新发送数据；</li>
<li>此后的TCP连接和非TFO的正常情况一致。</li>
</ol>
<p>注：客户端在请求并存储了Fast Open Cookie之后，可以不断重复TCP Fast Open直至服务器认为Cookie无效（通常为过期）。[<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/TCP快速打开#cite_note-IETF-RFC-7413-4">4]</a></p>
<h1 id="为什么-tcpip-协议会拆分数据">为什么 TCP/IP 协议会拆分数据</h1>
<ul>
<li>IP 协议会分片传输过大的数据包（Packet）避免物理设备的限制；</li>
<li>TCP 协议会分段传输过大的数据段（Segment）保证传输的性能；</li>
<li>IP 协议拆分数据是因为<strong>物理设备的限制</strong>，一次能够传输的数据由路径上 MTU 最小的设备决定，一旦 IP 协议传输的数据包超过 MTU 的限制就会发生分片，所以我们需要通过路径 MTU 发现获取传输路径上的 MTU 限制；</li>
<li>TCP 协议拆分数据是为了保证传输的可靠性和顺序，作为可靠的传输协议，为了保证数据的传输顺序，它需要为每一个数据段增加包含序列号的 TCP 协议头，如果数据段大小超过了 IP 协议的 MTU 限制， 就会带来更多额外的<strong>重传</strong>和重组开销，影响性能。</li>
</ul>
<p>一个IP数据报在以太网中传输，如果它的长度大于当前链路MTU值，就要进行<strong>分片传输(这里指IP层分片)</strong>，使得每片数据报的长度都不超过MTU。<strong>分片传输的IP数据报不一定按序到达，但IP首部中的信息能让这些数据报片按序组装</strong>。IP数据报的分片与重组是在网络IP层完成的。</p>
<h1 id="为什么-https-需要-7-次握手以及-9-倍时延">为什么 HTTPS 需要 7 次握手以及 9 倍时延</h1>
<p>tls 过程</p>
<figure>
<img src="https://raw.githubusercontent.com/SinosGray/picgo/master/test/202312281456570.png" alt="tls-1-2-handshake" /><figcaption aria-hidden="true">tls-1-2-handshake</figcaption>
</figure>
<ol type="1">
<li>客户端向服务端发送 Client Hello 消息，其中携带客户端支持的协议版本、加密算法、压缩算法以及<strong>客户端生成的随机数</strong>；</li>
<li>服务端收到客户端支持的协议版本、加密算法等信息后；
<ol type="1">
<li>向客户端发送 Server Hello 消息，并携带选择特定的协议版本、加密方法、会话 ID 以及<strong>服务端生成的随机数</strong>；</li>
<li>向客户端发送 Certificate 消息，即服务端的证书链，其中包含证书支持的域名、发行方和有效期等信息；</li>
<li>向客户端发送 Server Key Exchange 消息，传递<strong>公钥</strong>以及签名等信息；</li>
<li>向客户端发送可选的消息 CertificateRequest，验证客户端的证书；</li>
<li>向客户端发送 Server Hello Done 消息，通知服务端已经发送了全部的相关信息；</li>
</ol></li>
<li>客户端收到服务端的协议版本、加密方法、会话 ID 以及证书等信息后，验证服务端的证书；
<ol type="1">
<li>向服务端发送 Client Key Exchange 消息，包含<strong>使用服务端公钥加密后的随机字符串</strong>，即<strong>预主密钥（Pre Master Secret）</strong>； <code>masterkey = PRF(pre_master_key, clienthello.random+serverhello_random)</code> 其中 prf 是一个算法</li>
<li>向服务端发送 Change Cipher Spec 消息，通知服务端后面的数据段会加密传输；</li>
<li>向服务端发送 Finished 消息，其中包含加密后的握手信息；</li>
</ol></li>
<li>服务端收到 Change Cipher Spec 和 Finished 消息后；
<ol type="1">
<li>向客户端发送 Change Cipher Spec 消息，通知客户端后面的数据段会加密传输；</li>
<li>向客户端发送 Finished 消息，验证客户端的 Finished 消息并完成 TLS 握手；</li>
</ol></li>
</ol>
<blockquote>
<h3 id="what-is-a-client-certificate">What is a Client Certificate?</h3>
<p>Client certificates are, as the name indicates, used to identify a client or a user, authenticating the client to the server and establishing precisely who they are. To some, the mention of <a target="_blank" rel="noopener" href="https://www.digicert.com/what-is-pki">PKI</a> or ‘Client Certificates’ may conjure up images of businesses protecting and completing their customers’ online transactions, yet such certificates are found throughout our daily lives, in any number of flavors; when we sign into a VPN, use a bank card at an ATM, or a card to gain access to a building or within public transport smart cards. These digital certificates are even found in petrol pumps, the robots on car assembly lines and even in our passports.</p>
<p>In Continental Europe and in many other countries, the use of client certificates is particularly widespread, with governments issuing ID cards that have multiple uses, such as to pay local taxes, electricity bills and for drivers’ licenses. And the reason why is simple—client certificates play a vital role in ensuring people are safe online.</p>
</blockquote>
<p>https时延总结</p>
<ol type="1">
<li>TCP 协议需要通过三次握手建立 TCP 连接保证通信的可靠性（1.5-RTT）；</li>
<li>TLS 协议会在 TCP 协议之上通过四次握手建立 TLS 连接保证通信的安全性（2-RTT）；</li>
<li>HTTP 协议会在 TCP 和 TLS 上通过一次往返发送请求并接收响应（1-RTT）；</li>
</ol>
<h1 id="为什么-tcp-协议有粘包问题">为什么 TCP 协议有粘包问题</h1>
<ul>
<li>TCP 协议是面向字节流的协议，它可能会组合或者拆分应用层协议的数据；</li>
<li>应用层协议的没有定义消息的边界导致数据的接收方无法拼接数据；</li>
</ul>
<p>如果我们能在应用层协议中定义消息的边界，那么无论 TCP 协议如何对应用层协议的数据包进程拆分和重组，接收方都能根据协议的规则恢复对应的消息。在应用层协议中，最常见的两种解决方案就是基于长度或者基于终结符（Delimiter）</p>
<h1 id="为什么-tcp-协议有-time_wait-状态">为什么 TCP 协议有 TIME_WAIT 状态</h1>
<p><img src="https://raw.githubusercontent.com/SinosGray/picgo/master/test/202312281543222.png" alt="image-20231228154306120" style="zoom:67%;" /></p>
<figure>
<img src="https://raw.githubusercontent.com/SinosGray/picgo/master/test/202401231944627.jpeg" alt="img" /><figcaption aria-hidden="true">img</figcaption>
</figure>
<p>网络中可能存在来自发起方的数据段，当这些发起方的数据段被服务端处理后又会向客户端发送响应，所以一来一回需要等待 2 倍的时间。</p>
<h1 id="数据库为什么不使用外键">数据库为什么不使用外键</h1>
<p>假设我们的数据库中包含 <code>posts(id, author_id, content)</code> 和 <code>authors(id, name)</code> 两张表，在执行如下所示的操作时都会触发数据库对外键的检查：</p>
<ul>
<li>向 <code>posts</code> 表中插入数据时，检查 <code>author_id</code> 是否在 <code>authors</code> 表中存在；</li>
<li>修改 <code>posts</code> 表中的数据时，检查 <code>author_id</code> 是否在 <code>authors</code> 表中存在；</li>
<li>删除 <code>authors</code> 表中的数据时，检查 <code>posts</code> 中是否存在引用当前记录的外键；</li>
</ul>
<p>想要在应用程序中模拟数据库外键的功能其实比较容易，我们只需要遵循以下的几个准则：</p>
<ul>
<li>向表中插入数据或者修改表中的数据时，都应该执行额外的 <code>SELECT</code> 语句确保它引用的数据在数据库中存在；</li>
<li>在删除数据之前需要执行额外的 <code>SELECT</code> 语句检查是否存在当前记录的引用；</li>
</ul>
<p>外键提供的几种在更新和删除时的不同行为都可以帮助我们保证数据库中数据的一致性和引用合法性，但是外键的使用也需要数据库承担额外的开销，在大多数服务都可以水平扩容的今天，高并发场景中使用外键确实会影响服务的吞吐量上限。在数据库之外手动实现外键的功能是可能的，但是却会带来很多维护上的成本或者需要我们在数据一致性上做出一些妥协。我们可以从可用性、一致性几个方面分析使用外键、模拟外键以及不使用外键的差异：</p>
<ul>
<li>不使用外键牺牲了数据库中数据的一致性，但是却能够减少数据库的负载；</li>
<li>模拟外键将一部分工作移到了数据库之外，我们可能需要放弃一部分一致性以获得更高的可用性，但是为了这部分可用性，我们会付出更多的研发与维护成本，也增加了与数据库之间的网络通信次数；</li>
<li>使用外键保证了数据库中数据的一致性，也将全部的计算任务全部交给了数据库；</li>
</ul>
<h1 id="为什么-linux-需要-swapping">为什么 Linux 需要 Swapping</h1>
<ul>
<li><p>Swap 分区是硬盘上的独立区域，该区域只会用于交换分区，其他的文件不能存储在该区域上，我们可以使用 <code>swapon -s</code> 命令查看当前系统上的交换分区；</p></li>
<li><p>Swap 文件是文件系统中的特殊文件，它与文件系统中的其他文件也没有太多的区别；</p></li>
<li><p>Swapping 可以直接将进程中使用相对较少的页面换出内存，立刻给正在执行的进程分配内存；</p></li>
<li><p>Swapping 可以将进程中的闲置页面换出内存，为其他进程未来使用内存做好准备；</p></li>
</ul>
<p>当系统需要的内存超过了可用的物理内存时，内核会将内存中不常使用的内存页交换到磁盘上为当前进程让出内存，保证正在执行的进程的可用性，这个内存回收的过程是强制的直接内存回收（Direct Page Reclaim）。</p>
<ul>
<li>Swapping 可以直接将进程中使用相对较少的页面换出内存：当系统需要的内存超过了可用的物理内存时，内核会将内存中不常使用的内存页交换到磁盘上为当前进程让出内存，保证正在执行的进程的可用性；</li>
<li>Swapping 可以将进程中的闲置页面换出内存：应用程序在启动阶段使用的大量内存在启动后往往都不会使用，通过后台运行的守护进程，我们可以将这部分只使用一次的内存交换到磁盘上为其他内存申请预留空间；</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://sinos_wei.gitee.io">Sinos</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://sinos_wei.gitee.io/2023/12/149566d76407.html">https://sinos_wei.gitee.io/2023/12/149566d76407.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/cover/00000123.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/01/a6ef84649f8f.html" title="nodejs-project-structure"><img class="cover" src="/img/cover/00000197.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">nodejs-project-structure</div></div></a></div><div class="next-post pull-right"><a href="/2023/08/4eb2e1b2c3ff.html" title="system-design"><img class="cover" src="/img/cover/00000094.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">system-design</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Sinos</div><div class="author-info__description">己所不欲, 勿施于人</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">59</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">177</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">7</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/SinosGray"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/SinosGray" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:1143474942@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="http://8.130.42.149:5230" target="_blank" title="memo"><i class="fab fa-heart"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-tcp-%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5%E9%9C%80%E8%A6%81%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B"><span class="toc-number">1.</span> <span class="toc-text">为什么 TCP 建立连接需要三次握手</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8%E9%80%9A%E4%BF%A1%E6%9D%A5%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98"><span class="toc-number">2.</span> <span class="toc-text">为什么使用通信来共享内存</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-redis-%E9%80%89%E6%8B%A9%E5%8D%95%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B"><span class="toc-number">3.</span> <span class="toc-text">为什么 Redis 选择单线程模型</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-dns-%E4%BD%BF%E7%94%A8-udp-%E5%8D%8F%E8%AE%AE"><span class="toc-number">4.</span> <span class="toc-text">为什么 DNS 使用 UDP 协议</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#udp-%E4%B8%8E-mtu"><span class="toc-number">5.</span> <span class="toc-text">udp 与 mtu</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E6%97%A0%E6%84%8F%E4%B9%89-id"><span class="toc-number">6.</span> <span class="toc-text">为什么需要无意义 id</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-mysql-%E4%BD%BF%E7%94%A8-b-%E6%A0%91"><span class="toc-number">7.</span> <span class="toc-text">为什么 MySQL 使用 B+ 树</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-mongodb-%E4%BD%BF%E7%94%A8-b-%E6%A0%91"><span class="toc-number">8.</span> <span class="toc-text">为什么 MongoDB 使用 B 树</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-tcp-%E5%8D%8F%E8%AE%AE%E6%9C%89%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98"><span class="toc-number">9.</span> <span class="toc-text">为什么 TCP 协议有性能问题</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#tcp-%E5%92%8C-udp-%E5%8F%AF%E4%BB%A5%E5%90%8C%E6%97%B6%E7%BB%91%E5%AE%9A%E7%9B%B8%E5%90%8C%E7%9A%84%E7%AB%AF%E5%8F%A3%E5%90%97"><span class="toc-number">10.</span> <span class="toc-text">TCP 和 UDP 可以同时绑定相同的端口吗？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82fast-open-cookie"><span class="toc-number">10.0.1.</span> <span class="toc-text">请求Fast Open Cookie</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%96%BDtcp-fast-open"><span class="toc-number">10.0.2.</span> <span class="toc-text">实施TCP Fast Open</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-tcpip-%E5%8D%8F%E8%AE%AE%E4%BC%9A%E6%8B%86%E5%88%86%E6%95%B0%E6%8D%AE"><span class="toc-number">11.</span> <span class="toc-text">为什么 TCP&#x2F;IP 协议会拆分数据</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-https-%E9%9C%80%E8%A6%81-7-%E6%AC%A1%E6%8F%A1%E6%89%8B%E4%BB%A5%E5%8F%8A-9-%E5%80%8D%E6%97%B6%E5%BB%B6"><span class="toc-number">12.</span> <span class="toc-text">为什么 HTTPS 需要 7 次握手以及 9 倍时延</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#what-is-a-client-certificate"><span class="toc-number">12.0.1.</span> <span class="toc-text">What is a Client Certificate?</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-tcp-%E5%8D%8F%E8%AE%AE%E6%9C%89%E7%B2%98%E5%8C%85%E9%97%AE%E9%A2%98"><span class="toc-number">13.</span> <span class="toc-text">为什么 TCP 协议有粘包问题</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-tcp-%E5%8D%8F%E8%AE%AE%E6%9C%89-time_wait-%E7%8A%B6%E6%80%81"><span class="toc-number">14.</span> <span class="toc-text">为什么 TCP 协议有 TIME_WAIT 状态</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E4%BD%BF%E7%94%A8%E5%A4%96%E9%94%AE"><span class="toc-number">15.</span> <span class="toc-text">数据库为什么不使用外键</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-linux-%E9%9C%80%E8%A6%81-swapping"><span class="toc-number">16.</span> <span class="toc-text">为什么 Linux 需要 Swapping</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/01/e6a15612f4ba.html" title="react"><img src="/img/cover/00000106.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="react"/></a><div class="content"><a class="title" href="/2024/01/e6a15612f4ba.html" title="react">react</a><time datetime="2024-03-16T10:50:18.214Z" title="Updated 2024-03-16 18:50:18">2024-03-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/1d8ca121605c.html" title="计算机网络"><img src="/img/cover/IMG_3288.JPG" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="计算机网络"/></a><div class="content"><a class="title" href="/2023/05/1d8ca121605c.html" title="计算机网络">计算机网络</a><time datetime="2024-03-16T10:49:10.160Z" title="Updated 2024-03-16 18:49:10">2024-03-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/02/5806ce248c33.html" title="Xcode swift"><img src="/img/cover/00000084.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Xcode swift"/></a><div class="content"><a class="title" href="/2020/02/5806ce248c33.html" title="Xcode swift">Xcode swift</a><time datetime="2024-03-16T10:49:06.401Z" title="Updated 2024-03-16 18:49:06">2024-03-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/07/a6f2ba33bf73.html" title="ts js html"><img src="/img/cover/00000076.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ts js html"/></a><div class="content"><a class="title" href="/2023/07/a6f2ba33bf73.html" title="ts js html">ts js html</a><time datetime="2024-03-16T10:41:04.471Z" title="Updated 2024-03-16 18:41:04">2024-03-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/03/59cb1b4312ed.html" title="cppdoc"><img src="/img/cover/222.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="cppdoc"/></a><div class="content"><a class="title" href="/2024/03/59cb1b4312ed.html" title="cppdoc">cppdoc</a><time datetime="2024-03-16T07:15:48.735Z" title="Updated 2024-03-16 15:15:48">2024-03-16</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Sinos</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container').forEach(node => {
            if (node.hasAttribute('display')) {
              btf.wrap(node, 'div', { class: 'mathjax-overflow' })
            } else {
              btf.wrap(node, 'span', { class: 'mathjax-overflow' })
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>