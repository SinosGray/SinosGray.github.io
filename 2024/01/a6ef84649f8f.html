<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>nodejs-project-structure | Sinos_wei's blog</title><meta name="author" content="Sinos"><meta name="copyright" content="Sinos"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="原文地址 https:&#x2F;&#x2F;www.softwareontheroad.com&#x2F;ideal-nodejs-project-structure&#x2F;?utm_source&#x3D;github&amp;utm_medium&#x3D;readme">
<meta property="og:type" content="article">
<meta property="og:title" content="nodejs-project-structure">
<meta property="og:url" content="https://sinos_wei.gitee.io/2024/01/a6ef84649f8f.html">
<meta property="og:site_name" content="Sinos_wei&#39;s blog">
<meta property="og:description" content="原文地址 https:&#x2F;&#x2F;www.softwareontheroad.com&#x2F;ideal-nodejs-project-structure&#x2F;?utm_source&#x3D;github&amp;utm_medium&#x3D;readme">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://sinos_wei.gitee.io/img/cover/00000197.jpg">
<meta property="article:published_time" content="2024-01-04T09:49:52.000Z">
<meta property="article:modified_time" content="2024-01-04T11:41:32.798Z">
<meta property="article:author" content="Sinos">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sinos_wei.gitee.io/img/cover/00000197.jpg"><link rel="shortcut icon" href="/img/avatar.jpeg"><link rel="canonical" href="https://sinos_wei.gitee.io/2024/01/a6ef84649f8f.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?aeddd8219bc5c1e1efdcf5d9cc3218e6";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'nodejs-project-structure',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-01-04 19:41:32'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">67</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">199</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">8</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/cover/00000197.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Sinos_wei's blog"><span class="site-name">Sinos_wei's blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">nodejs-project-structure</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon fas fa-history"></i><span class="post-meta-label">Updated</span><time datetime="2024-01-04T11:41:32.798Z" title="Updated 2024-01-04 19:41:32">2024-01-04</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="nodejs-project-structure"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>原文地址 https://www.softwareontheroad.com/ideal-nodejs-project-structure/?utm_source=github&amp;utm_medium=readme</p>
</blockquote>
<span id="more"></span>
<h1 id="bulletproof-node.js-project-architecture">Bulletproof node.js project architecture 🛡️</h1>
<p><strong>Update 04/21/2019: <a target="_blank" rel="noopener" href="https://github.com/santiq/bulletproof-nodejs">Implementation example repository</a></strong></p>
<p>Express.js is great frameworks for making a node.js REST APIs however it doesn't give you any clue on how to organizing your node.js project.</p>
<p>While it may sound silly, this is a real problem.</p>
<p>The correct organization of your node.js project structure will avoid duplication of code, will improve stability, and potentially, will help you scale your services if is done correctly.</p>
<p>This post is extense research, from my years of experience dealing with a poor structured node.js project, bad patterns, and countless hours of refactoring code and moving things around.</p>
<p>If you need help to align your node.js project architecture, just drop me a letter at <a href="mailto:sam@softwareontheroad.com">sam@softwareontheroad.com</a></p>
<ul>
<li><a href="#folder">The folder structure 🏢</a></li>
<li><a href="#architecture">3 Layer architecture 🥪</a></li>
<li><a href="#service">Service Layer 💼</a></li>
<li><a href="#pubsub">Pub/Sub Layer ️️️️🎙️️</a></li>
<li><a href="#di">Dependency Injection 💉</a></li>
<li><a href="#test">Unit Testing 🕵🏻</a></li>
<li><a href="#cron">Cron Jobs and recurring task ⚡</a></li>
<li><a href="#configs">Configurations and secrets 🤫</a></li>
<li><a href="#loaders">Loaders 🏗️</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/santiq/bulletproof-nodejs">Example repository</a></li>
</ul>
<p>Here is the node.js project structure that I'm talking about.</p>
<p>I use this in every node.js REST API service that I build, let's see in details what every component do.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">src</span><br><span class="line">│   app.js          # App entry point</span><br><span class="line">└───api             # Express route controllers for all the endpoints of the app</span><br><span class="line">└───config          # Environment variables and configuration related stuff</span><br><span class="line">└───jobs            # Jobs definitions for agenda.js</span><br><span class="line">└───loaders         # Split the startup process into modules</span><br><span class="line">└───models          # Database models</span><br><span class="line">└───services        # All the business logic is here</span><br><span class="line">└───subscribers     # Event handlers for async task</span><br><span class="line">└───types           # Type declaration files (d.ts) for Typescript</span><br></pre></td></tr></table></figure>
<p>It is more than just a way of ordering javascript files...</p>
<p><strong>The idea is to use the principle of separation of concerns to move the business logic away from the node.js API Routes.</strong></p>
<p><a target="_blank" rel="noopener" href="https://www.softwareontheroad.com/static/122dab3154cb7e417bbb210bbce7ca01/8299d/server_layers.jpg"><img src="https://raw.githubusercontent.com/SinosGray/picgo/master/test/202401041752990.jpg" alt="3 layer pattern" /></a></p>
<p>Because someday, you will want to use your business logic on a CLI tool, or not going far, in a recurring task.</p>
<p>And make an API call from the node.js server to itself it's not a good idea...</p>
<p><a target="_blank" rel="noopener" href="https://www.softwareontheroad.com/static/1a21f74cfc4c965f00324afd39642b9f/8299d/server_layers_2.jpg"><img src="https://raw.githubusercontent.com/SinosGray/picgo/master/test/202401041752607.jpg" alt="3 layer pattern for node.js REST API" /></a></p>
<h2 id="dont-put-your-business-logic-inside-the-controllers">☠️ Don't put your business logic inside the controllers!! ☠️</h2>
<p>You may be tempted to just use the express.js controllers to store the business logic of your application, but this quickly becomes spaghetti code, as soon as you need to write unit tests, you will end up dealing with complex mocks for <em>req</em> or <em>res</em> express.js objects.</p>
<p>It's complicated to distingue when a response should be sent, and when to continue processing in 'background', let's say after the response is sent to the client.</p>
<p>Here is an example of what not to do.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">route.<span class="title function_">post</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">async</span> (req, res, next) =&gt; &#123;  </span><br><span class="line">  <span class="keyword">const</span> userDTO = req.<span class="property">body</span>;</span><br><span class="line">  <span class="keyword">const</span> isUserValid = validators.<span class="title function_">user</span>(userDTO)</span><br><span class="line">  <span class="keyword">if</span>(!isUserValid) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">end</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> userRecord = <span class="keyword">await</span> <span class="title class_">UserModel</span>.<span class="title function_">create</span>(userDTO);</span><br><span class="line">  <span class="keyword">delete</span> userRecord.<span class="property">password</span>;</span><br><span class="line">  <span class="keyword">delete</span> userRecord.<span class="property">salt</span>;</span><br><span class="line">  <span class="keyword">const</span> companyRecord = <span class="keyword">await</span> <span class="title class_">CompanyModel</span>.<span class="title function_">create</span>(userRecord);</span><br><span class="line">  <span class="keyword">const</span> companyDashboard = <span class="keyword">await</span> <span class="title class_">CompanyDashboard</span>.<span class="title function_">create</span>(userRecord, companyRecord);</span><br><span class="line"></span><br><span class="line">  ...whatever...</span><br><span class="line"></span><br><span class="line">  res.<span class="title function_">json</span>(&#123; <span class="attr">user</span>: userRecord, <span class="attr">company</span>: companyRecord &#125;);</span><br><span class="line">  <span class="keyword">const</span> salaryRecord = <span class="keyword">await</span> <span class="title class_">SalaryModel</span>.<span class="title function_">create</span>(userRecord, companyRecord);</span><br><span class="line">  eventTracker.<span class="title function_">track</span>(<span class="string">&#x27;user_signup&#x27;</span>,userRecord,companyRecord,salaryRecord);</span><br><span class="line">  intercom.<span class="title function_">createUser</span>(userRecord);</span><br><span class="line">  gaAnalytics.<span class="title function_">event</span>(<span class="string">&#x27;user_signup&#x27;</span>,userRecord);</span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">EmailService</span>.<span class="title function_">startSignupSequence</span>(userRecord)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="use-a-service-layer-for-your-business-logic">Use a <strong>service layer</strong> for your business logic</h1>
<p>This layer is where your business logic should live.</p>
<p>It's just a collection of classes with clear purposes, following the <strong>SOLID</strong> principles applied to node.js.</p>
<p><strong><em>In this layer there should not exists any form of 'SQL query', use the data access layer for that.</em></strong></p>
<ul>
<li><p>Move your code away from the express.js router</p></li>
<li><p>Don't pass the req or res object to the service layer</p></li>
<li><p>Don't return anything related to the HTTP transport layer like a status code or headers from the service layer.</p></li>
</ul>
<p><strong>Example</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">route.<span class="title function_">post</span>(<span class="string">&#x27;/&#x27;</span>, </span><br><span class="line">  validators.<span class="property">userSignup</span>, </span><br><span class="line">  <span class="keyword">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> userDTO = req.<span class="property">body</span>;</span><br><span class="line">    <span class="keyword">const</span> &#123; user, company &#125; = <span class="keyword">await</span> <span class="title class_">UserService</span>.<span class="title class_">Signup</span>(userDTO);</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">json</span>(&#123; user, company &#125;);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p>Here is how your service will be working behind the scenes.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">UserModel</span> <span class="keyword">from</span> <span class="string">&#x27;../models/user&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">CompanyModel</span> <span class="keyword">from</span> <span class="string">&#x27;../models/company&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">UserService</span>() &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title class_">Signup</span>(user) &#123;</span><br><span class="line">    <span class="keyword">const</span> userRecord = <span class="keyword">await</span> <span class="title class_">UserModel</span>.<span class="title function_">create</span>(user);</span><br><span class="line">    <span class="keyword">const</span> companyRecord = <span class="keyword">await</span> <span class="title class_">CompanyModel</span>.<span class="title function_">create</span>(userRecord); </span><br><span class="line">    <span class="keyword">const</span> salaryRecord = <span class="keyword">await</span> <span class="title class_">SalaryModel</span>.<span class="title function_">create</span>(userRecord, companyRecord); </span><br><span class="line">    ...whatever</span><br><span class="line">    <span class="keyword">await</span> <span class="title class_">EmailService</span>.<span class="title function_">startSignupSequence</span>(userRecord)</span><br><span class="line">    ...<span class="keyword">do</span> more stuff</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">user</span>: userRecord, <span class="attr">company</span>: companyRecord &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/santiq/bulletproof-nodejs">Visit the example repository</a></p>
<h1 id="use-a-pubsubpublishsubscribe-pattern-layer-too">Use a Pub/Sub(Publish–subscribe pattern) layer too</h1>
<blockquote>
<p>在<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/软件架构">软件架构</a>中，发布/订阅（Publish–subscribe pattern）是一种<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/消息">消息</a><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/范式">范式</a>，消息的发送者（称为发布者）不会将消息直接发送给特定的接收者（称为订阅者）。而是将发布的消息分为不同的类别，无需了解哪些订阅者（如果有的话）可能存在。同样的，订阅者可以表达对一个或多个类别的兴趣，只接收感兴趣的消息，无需了解哪些发布者（如果有的话）存在。</p>
</blockquote>
<p>The pub/sub pattern goes beyond the classic 3 layer architecture proposed here but it's extremely useful.</p>
<p>The simple node.js API endpoint that creates a user right now, may want to call third-party services, maybe to an analytics service, or maybe start an email sequence.</p>
<p>Sooner than later, that simple "create" operation will be doing several things, and you will end up with 1000 lines of code, all in a single function.</p>
<p>That violates the principle of single responsibility.</p>
<p>So, it's better to separate responsibilities from the start, so your code remains maintainable.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">UserModel</span> <span class="keyword">from</span> <span class="string">&#x27;../models/user&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">CompanyModel</span> <span class="keyword">from</span> <span class="string">&#x27;../models/company&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">SalaryModel</span> <span class="keyword">from</span> <span class="string">&#x27;../models/salary&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">UserService</span>() &#123;</span><br><span class="line">  <span class="keyword">async</span> <span class="title class_">Signup</span>(user) &#123;</span><br><span class="line">    <span class="keyword">const</span> userRecord = <span class="keyword">await</span> <span class="title class_">UserModel</span>.<span class="title function_">create</span>(user);</span><br><span class="line">    <span class="keyword">const</span> companyRecord = <span class="keyword">await</span> <span class="title class_">CompanyModel</span>.<span class="title function_">create</span>(user);</span><br><span class="line">    <span class="keyword">const</span> salaryRecord = <span class="keyword">await</span> <span class="title class_">SalaryModel</span>.<span class="title function_">create</span>(user, salary);</span><br><span class="line"></span><br><span class="line">    eventTracker.<span class="title function_">track</span>(</span><br><span class="line">      <span class="string">&#x27;user_signup&#x27;</span>,</span><br><span class="line">      userRecord,</span><br><span class="line">      companyRecord,</span><br><span class="line">      salaryRecord</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    intercom.<span class="title function_">createUser</span>(</span><br><span class="line">      userRecord</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    gaAnalytics.<span class="title function_">event</span>(</span><br><span class="line">      <span class="string">&#x27;user_signup&#x27;</span>,</span><br><span class="line">      userRecord</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">await</span> <span class="title class_">EmailService</span>.<span class="title function_">startSignupSequence</span>(userRecord)</span><br><span class="line">    ...more stuff</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">user</span>: userRecord, <span class="attr">company</span>: companyRecord &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>An imperative call to a dependent service is not the best way of doing it.</strong></p>
<p>A better approach is by emitting an event i.e. 'a user signed up with this email'.</p>
<p>And you are done, now it's the responsibility of the listeners to do their job.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">UserModel</span> <span class="keyword">from</span> <span class="string">&#x27;../models/user&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">CompanyModel</span> <span class="keyword">from</span> <span class="string">&#x27;../models/company&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">SalaryModel</span> <span class="keyword">from</span> <span class="string">&#x27;../models/salary&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">UserService</span>() &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title class_">Signup</span>(user) &#123;</span><br><span class="line">    <span class="keyword">const</span> userRecord = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">userModel</span>.<span class="title function_">create</span>(user);</span><br><span class="line">    <span class="keyword">const</span> companyRecord = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">companyModel</span>.<span class="title function_">create</span>(user);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">eventEmitter</span>.<span class="title function_">emit</span>(<span class="string">&#x27;user_signup&#x27;</span>, &#123; <span class="attr">user</span>: userRecord, <span class="attr">company</span>: companyRecord &#125;)</span><br><span class="line">    <span class="keyword">return</span> userRecord</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Now you can split the event handlers/listeners into multiple files.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">eventEmitter.<span class="title function_">on</span>(<span class="string">&#x27;user_signup&#x27;</span>, <span class="function">(<span class="params">&#123; user, company &#125;</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">  eventTracker.<span class="title function_">track</span>(</span><br><span class="line">    <span class="string">&#x27;user_signup&#x27;</span>,</span><br><span class="line">    user,</span><br><span class="line">    company,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  intercom.<span class="title function_">createUser</span>(</span><br><span class="line">    user</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  gaAnalytics.<span class="title function_">event</span>(</span><br><span class="line">    <span class="string">&#x27;user_signup&#x27;</span>,</span><br><span class="line">    user</span><br><span class="line">  );</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">eventEmitter.<span class="title function_">on</span>(<span class="string">&#x27;user_signup&#x27;</span>, <span class="keyword">async</span> (&#123; user, company &#125;) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> salaryRecord = <span class="keyword">await</span> <span class="title class_">SalaryModel</span>.<span class="title function_">create</span>(user, company);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">eventEmitter.<span class="title function_">on</span>(<span class="string">&#x27;user_signup&#x27;</span>, <span class="keyword">async</span> (&#123; user, company &#125;) =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">EmailService</span>.<span class="title function_">startSignupSequence</span>(user)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>You can wrap the await statements into a try-catch block or <a target="_blank" rel="noopener" href="https://www.softwareontheroad.com/nodejs-crash-exception-handler">you can just let it fail and handle the 'unhandledPromise' <em>process.on('unhandledRejection',cb)</em></a></p>
<h1 id="dependency-injection">Dependency Injection</h1>
<p>D.I. or inversion of control (IoC) is a common pattern that will help the organization of your code, by 'injecting' or passing through the constructor the <em>dependencies</em> of your class or function.</p>
<p>By doing this way you will gain the flexibility to inject a <em>'compatible dependency'</em> when, for example, you write the unit tests for the service, or when the service is used in another context.</p>
<p><em>Code with no D.I</em></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">UserModel</span> <span class="keyword">from</span> <span class="string">&#x27;../models/user&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">CompanyModel</span> <span class="keyword">from</span> <span class="string">&#x27;../models/company&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">SalaryModel</span> <span class="keyword">from</span> <span class="string">&#x27;../models/salary&#x27;</span>;  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>)&#123;&#125;</span><br><span class="line">  <span class="title class_">Sigup</span>()&#123;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>Code with manual dependency injection</em></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">userModel, companyModel, salaryModel</span>)&#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">userModel</span> = userModel;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">companyModel</span> = companyModel;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">salaryModel</span> = salaryModel;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">getMyUser</span>(<span class="params">userId</span>)&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> user = <span class="variable language_">this</span>.<span class="property">userModel</span>.<span class="title function_">findById</span>(userId);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Now you can inject custom dependencies.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">UserService</span> <span class="keyword">from</span> <span class="string">&#x27;../services/user&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">UserModel</span> <span class="keyword">from</span> <span class="string">&#x27;../models/user&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">CompanyModel</span> <span class="keyword">from</span> <span class="string">&#x27;../models/company&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> salaryModelMock = &#123;</span><br><span class="line">  <span class="title function_">calculateNetSalary</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">42</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> userServiceInstance = <span class="keyword">new</span> <span class="title class_">UserService</span>(userModel, companyModel, salaryModelMock);</span><br><span class="line"><span class="keyword">const</span> user = <span class="keyword">await</span> userServiceInstance.<span class="title function_">getMyUser</span>(<span class="string">&#x27;12346&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>The amount of dependencies a service can have is infinite, and refactor every instantiation of it when you add a new one is a boring and error-prone task.</p>
<p>That's why dependency injection frameworks were created.</p>
<p>The idea is you declare your dependencies in the class, and when you need an instance of that class, you just call the 'Service Locator'.</p>
<p>Let's see an example using <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/typedi">typedi</a> an npm library that brings D.I to node.js</p>
<p><a target="_blank" rel="noopener" href="https://www.github.com/typestack/typedi">You can read more on how to use typedi in the official documentation</a></p>
<p><em>WARNING typescript example</em></p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Service</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;typedi&#x27;</span>;</span><br><span class="line"><span class="meta">@Service</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> userModel,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> companyModel, </span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> salaryModel</span></span><br><span class="line"><span class="params">  </span>)&#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getMyUser</span>(<span class="params">userId</span>)&#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="variable language_">this</span>.<span class="property">userModel</span>.<span class="title function_">findById</span>(userId);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>services/user.ts</em></p>
<p>Now <em>typedi</em> will take care of resolving any dependency the UserService require.</p>
<figure class="highlight ts"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Container</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;typedi&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">UserService</span> <span class="keyword">from</span> <span class="string">&#x27;../services/user&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> userServiceInstance = <span class="title class_">Container</span>.<span class="title function_">get</span>(<span class="title class_">UserService</span>);</span><br><span class="line"><span class="keyword">const</span> user = <span class="keyword">await</span> userServiceInstance.<span class="title function_">getMyUser</span>(<span class="string">&#x27;12346&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p><strong>Abusing service locator calls is an anti-pattern</strong></p>
<h2 id="using-dependency-injection-with-express.js-in-node.js">Using Dependency Injection with Express.js in Node.js</h2>
<p>Using D.I. in express.js is the final piece of the puzzle for this node.js project architecture.</p>
<p><strong>Routing layer</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">route.<span class="title function_">post</span>(<span class="string">&#x27;/&#x27;</span>, </span><br><span class="line">  <span class="keyword">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> userDTO = req.<span class="property">body</span>;</span><br><span class="line">    <span class="keyword">const</span> userServiceInstance = <span class="title class_">Container</span>.<span class="title function_">get</span>(<span class="title class_">UserService</span>) </span><br><span class="line">    <span class="keyword">const</span> &#123; user, company &#125; = userServiceInstance.<span class="title class_">Signup</span>(userDTO);</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">json</span>(&#123; user, company &#125;);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p>Awesome, project is looking great ! It's so organized that makes me want to be coding something right now.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/santiq/bulletproof-nodejs">Visit the example repository</a></p>
<h1 id="an-unit-test-example">An unit test example</h1>
<p>By using dependency injection and these organization patterns, unit testing becomes really simple.</p>
<p>You don't have to mock req/res objects or require(...) calls.</p>
<p><strong>Example: Unit test for signup user method</strong></p>
<p><em>tests/unit/services/user.js</em></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">UserService</span> <span class="keyword">from</span> <span class="string">&#x27;../../../src/services/user&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;User service unit tests&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">describe</span>(<span class="string">&#x27;Signup&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">test</span>(<span class="string">&#x27;Should create user record and emit user_signup event&#x27;</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> eventEmitterService = &#123;</span><br><span class="line">        <span class="attr">emit</span>: jest.<span class="title function_">fn</span>(),</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> userModel = &#123;</span><br><span class="line">        <span class="attr">create</span>: <span class="function">(<span class="params">user</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> &#123;</span><br><span class="line">            ...user,</span><br><span class="line">            <span class="attr">_id</span>: <span class="string">&#x27;mock-user-id&#x27;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> companyModel = &#123;</span><br><span class="line">        <span class="attr">create</span>: <span class="function">(<span class="params">user</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="attr">owner</span>: user.<span class="property">_id</span>,</span><br><span class="line">            <span class="attr">companyTaxId</span>: <span class="string">&#x27;12345&#x27;</span>,</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> userInput= &#123;</span><br><span class="line">        <span class="attr">fullname</span>: <span class="string">&#x27;User Unit Test&#x27;</span>,</span><br><span class="line">        <span class="attr">email</span>: <span class="string">&#x27;test@example.com&#x27;</span>,</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> userService = <span class="keyword">new</span> <span class="title class_">UserService</span>(userModel, companyModel, eventEmitterService);</span><br><span class="line">      <span class="keyword">const</span> userRecord = <span class="keyword">await</span> userService.<span class="title class_">SignUp</span>(teamId.<span class="title function_">toHexString</span>(), userInput);</span><br><span class="line"></span><br><span class="line">      <span class="title function_">expect</span>(userRecord).<span class="title function_">toBeDefined</span>();</span><br><span class="line">      <span class="title function_">expect</span>(userRecord.<span class="property">_id</span>).<span class="title function_">toBeDefined</span>();</span><br><span class="line">      <span class="title function_">expect</span>(eventEmitterService.<span class="property">emit</span>).<span class="title function_">toBeCalled</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="cron-jobs-and-recurring-task">Cron Jobs and recurring task</h1>
<p>So, now that the business logic encapsulated into the service layer, it's easier to use it from a Cron job.</p>
<p>You should never rely on node.js <code>setTimeout</code> or another primitive way of delay the execution of code, but on a framework that persist your jobs, and the execution of them, in a database.</p>
<p>This way you will have control over the failed jobs, and feedback of those who succeed. I already wrote on good practice for this so, <a target="_blank" rel="noopener" href="https://www.softwareontheroad.com/nodejs-scalability-issues">check my guide on using agenda.js the best task manager for node.js</a>.</p>
<h1 id="configurations-and-secrets">Configurations and secrets</h1>
<p>Following the battle-tested concepts of <a target="_blank" rel="noopener" href="https://12factor.net/">Twelve-Factor App</a> for node.js the best approach to store API Keys and database string connections, it's by using <strong>dotenv</strong>.</p>
<p>Put a <code>.env</code> file, that must never be committed <em>(but it has to exist with default values in your repository)</em> then, the npm package <code>dotenv</code> loads the .env file and insert the vars into the <code>process.env</code> object of node.js.</p>
<p>That could be enough but, I like to add an extra step. Have a <code>config/index.ts</code> file where the <code>dotenv</code> npm package loads the .env file and then I use an object to store the variables, so we have a structure and code autocompletion.</p>
<p><em>config/index.js</em></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">const dotenv = require(&#x27;dotenv&#x27;);</span><br><span class="line"></span><br><span class="line">dotenv.config();</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  port: process.env.PORT,</span><br><span class="line">  databaseURL: process.env.DATABASE_URI,</span><br><span class="line">  paypal: &#123;</span><br><span class="line">    publicKey: process.env.PAYPAL_PUBLIC_KEY,</span><br><span class="line">    secretKey: process.env.PAYPAL_SECRET_KEY,</span><br><span class="line">  &#125;,</span><br><span class="line">  paypal: &#123;</span><br><span class="line">    publicKey: process.env.PAYPAL_PUBLIC_KEY,</span><br><span class="line">    secretKey: process.env.PAYPAL_SECRET_KEY,</span><br><span class="line">  &#125;,</span><br><span class="line">  mailchimp: &#123;</span><br><span class="line">    apiKey: process.env.MAILCHIMP_API_KEY,</span><br><span class="line">    sender: process.env.MAILCHIMP_SENDER,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This way you avoid flooding your code with <code>process.env.MY_RANDOM_VAR</code> instructions, and by having the autocompletion you don't have to know how to name the env var.</p>
<p><a target="_blank" rel="noopener" href="https://github.com/santiq/bulletproof-nodejs">Visit the example repository</a></p>
<h1 id="loaders">Loaders</h1>
<p>I took this pattern from <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/microframework-w3tec">W3Tech microframework</a> but without depending upon their package.</p>
<p>The idea is that you split the startup process of your node.js service into testable modules.</p>
<p>Let's see a classic express.js app initialization</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">&#x27;mongoose&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">&#x27;express-session&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> cors = <span class="built_in">require</span>(<span class="string">&#x27;cors&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> errorhandler = <span class="built_in">require</span>(<span class="string">&#x27;errorhandler&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/status&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123; res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">end</span>(); &#125;);</span><br><span class="line">app.<span class="title function_">head</span>(<span class="string">&#x27;/status&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123; res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">end</span>(); &#125;);</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">cors</span>());</span><br><span class="line">app.<span class="title function_">use</span>(<span class="built_in">require</span>(<span class="string">&#x27;morgan&#x27;</span>)(<span class="string">&#x27;dev&#x27;</span>));</span><br><span class="line">app.<span class="title function_">use</span>(bodyParser.<span class="title function_">urlencoded</span>(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">app.<span class="title function_">use</span>(bodyParser.<span class="title function_">json</span>(setupForStripeWebhooks));</span><br><span class="line">app.<span class="title function_">use</span>(<span class="built_in">require</span>(<span class="string">&#x27;method-override&#x27;</span>)());</span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">static</span>(__dirname + <span class="string">&#x27;/public&#x27;</span>));</span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">session</span>(&#123; <span class="attr">secret</span>: process.<span class="property">env</span>.<span class="property">SECRET</span>, <span class="attr">cookie</span>: &#123; <span class="attr">maxAge</span>: <span class="number">60000</span> &#125;, <span class="attr">resave</span>: <span class="literal">false</span>, <span class="attr">saveUninitialized</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">mongoose.<span class="title function_">connect</span>(process.<span class="property">env</span>.<span class="property">DATABASE_URL</span>, &#123; <span class="attr">useNewUrlParser</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;./config/passport&#x27;</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;./models/user&#x27;</span>);</span><br><span class="line"><span class="built_in">require</span>(<span class="string">&#x27;./models/company&#x27;</span>);</span><br><span class="line">app.<span class="title function_">use</span>(<span class="built_in">require</span>(<span class="string">&#x27;./routes&#x27;</span>));</span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">var</span> err = <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Not Found&#x27;</span>);</span><br><span class="line">  err.<span class="property">status</span> = <span class="number">404</span>;</span><br><span class="line">  <span class="title function_">next</span>(err);</span><br><span class="line">&#125;);</span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">err, req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">status</span>(err.<span class="property">status</span> || <span class="number">500</span>);</span><br><span class="line">  res.<span class="title function_">json</span>(&#123;<span class="string">&#x27;errors&#x27;</span>: &#123;</span><br><span class="line">    <span class="attr">message</span>: err.<span class="property">message</span>,</span><br><span class="line">    <span class="attr">error</span>: &#123;&#125;</span><br><span class="line">  &#125;&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">... more stuff </span><br><span class="line">... maybe start up <span class="title class_">Redis</span></span><br><span class="line">... maybe add more middlewares</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">startServer</span>(<span class="params"></span>) &#123;    </span><br><span class="line">  app.<span class="title function_">listen</span>(process.<span class="property">env</span>.<span class="property">PORT</span>, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Your server is ready !`</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">startServer</span>();</span><br></pre></td></tr></table></figure>
<p>As you see, this part of your application can be a real mess.</p>
<p>Here is an effective way to deal with it.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> loaders = <span class="built_in">require</span>(<span class="string">&#x27;./loaders&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">startServer</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line">  <span class="keyword">await</span> loaders.<span class="title function_">init</span>(&#123; <span class="attr">expressApp</span>: app &#125;);</span><br><span class="line">  app.<span class="title function_">listen</span>(process.<span class="property">env</span>.<span class="property">PORT</span>, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Your server is ready !`</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">startServer</span>();</span><br></pre></td></tr></table></figure>
<p>Now the loaders are just tiny files with a concise purpose</p>
<p><em>loaders/index.js</em></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> expressLoader <span class="keyword">from</span> <span class="string">&#x27;./express&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> mongooseLoader <span class="keyword">from</span> <span class="string">&#x27;./mongoose&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> (&#123; expressApp &#125;) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> mongoConnection = <span class="keyword">await</span> <span class="title function_">mongooseLoader</span>();</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;MongoDB Initialized&#x27;</span>);</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">expressLoader</span>(&#123; <span class="attr">app</span>: expressApp &#125;);</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Express Initialized&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The express loader</p>
<p><em>loaders/express.js</em></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> express <span class="keyword">from</span> <span class="string">&#x27;express&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> bodyParser <span class="keyword">from</span> <span class="string">&#x27;body-parser&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> cors <span class="keyword">from</span> <span class="string">&#x27;cors&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> (&#123; app &#125;: &#123; <span class="attr">app</span>: express.<span class="property">Application</span> &#125;) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">  app.<span class="title function_">get</span>(<span class="string">&#x27;/status&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123; res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">end</span>(); &#125;);</span><br><span class="line">  app.<span class="title function_">head</span>(<span class="string">&#x27;/status&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123; res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">end</span>(); &#125;);</span><br><span class="line">  app.<span class="title function_">enable</span>(<span class="string">&#x27;trust proxy&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  app.<span class="title function_">use</span>(<span class="title function_">cors</span>());</span><br><span class="line">  app.<span class="title function_">use</span>(<span class="built_in">require</span>(<span class="string">&#x27;morgan&#x27;</span>)(<span class="string">&#x27;dev&#x27;</span>));</span><br><span class="line">  app.<span class="title function_">use</span>(bodyParser.<span class="title function_">urlencoded</span>(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line">  <span class="keyword">return</span> app;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>The mongo loader</p>
<p><em>loaders/mongoose.js</em></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import * as mongoose from &#x27;mongoose&#x27;</span><br><span class="line">export default async (): Promise&lt;any&gt; =&gt; &#123;</span><br><span class="line">  const connection = await mongoose.connect(process.env.DATABASE_URL, &#123; useNewUrlParser: true &#125;);</span><br><span class="line">  return connection.connection.db;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="conclusion">Conclusion</h1>
<p>We deep dive into a production tested node.js project structure, here are some summarized tips:</p>
<ul>
<li><p>Use a 3 layer architecture.</p></li>
<li><p>Don't put your business logic into the express.js controllers.</p></li>
<li><p>Use PubSub pattern and emit events for background tasks.</p></li>
<li><p>Have dependency injection for your peace of mind.</p></li>
<li><p>Never leak your passwords, secrets and API keys, use a configuration manager.</p></li>
<li><p>Split your node.js server configurations into small modules that can be loaded independently.</p></li>
</ul>
<h3 id="see-the-example-repository-here"><a target="_blank" rel="noopener" href="https://github.com/santiq/bulletproof-nodejs">See the example repository here</a></h3>
<h4 id="get-the-latest-articles-in-your-inbox.">Get the latest articles in your inbox.</h4>
<p>Join the other 2000+ savvy node.js developers who get article updates. You will receive only high-quality articles about Node.js, Cloud Computing and Javascript front-end frameworks.</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://sinos_wei.gitee.io">Sinos</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://sinos_wei.gitee.io/2024/01/a6ef84649f8f.html">https://sinos_wei.gitee.io/2024/01/a6ef84649f8f.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/cover/00000197.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/01/a5b7e0f39f18.html" title="深入浅出nodejs"><img class="cover" src="/img/cover/00000083.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">深入浅出nodejs</div></div></a></div><div class="next-post pull-right"><a href="/2024/01/f52915be9043.html" title="webkit技术内幕读书笔记"><img class="cover" src="/img/cover/00000167.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">webkit技术内幕读书笔记</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Sinos</div><div class="author-info__description">己所不欲, 勿施于人</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">67</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">199</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/SinosGray"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/SinosGray" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:1143474942@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="http://8.130.42.149:5230" target="_blank" title="memo"><i class="fab fa-heart"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#bulletproof-node.js-project-architecture"><span class="toc-number">1.</span> <span class="toc-text">Bulletproof node.js project architecture 🛡️</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dont-put-your-business-logic-inside-the-controllers"><span class="toc-number">1.1.</span> <span class="toc-text">☠️ Don&#39;t put your business logic inside the controllers!! ☠️</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#use-a-service-layer-for-your-business-logic"><span class="toc-number">2.</span> <span class="toc-text">Use a service layer for your business logic</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#use-a-pubsubpublishsubscribe-pattern-layer-too"><span class="toc-number">3.</span> <span class="toc-text">Use a Pub&#x2F;Sub(Publish–subscribe pattern) layer too</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#dependency-injection"><span class="toc-number">4.</span> <span class="toc-text">Dependency Injection</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#using-dependency-injection-with-express.js-in-node.js"><span class="toc-number">4.1.</span> <span class="toc-text">Using Dependency Injection with Express.js in Node.js</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#an-unit-test-example"><span class="toc-number">5.</span> <span class="toc-text">An unit test example</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#cron-jobs-and-recurring-task"><span class="toc-number">6.</span> <span class="toc-text">Cron Jobs and recurring task</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#configurations-and-secrets"><span class="toc-number">7.</span> <span class="toc-text">Configurations and secrets</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#loaders"><span class="toc-number">8.</span> <span class="toc-text">Loaders</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#conclusion"><span class="toc-number">9.</span> <span class="toc-text">Conclusion</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#see-the-example-repository-here"><span class="toc-number">9.0.1.</span> <span class="toc-text">See the example repository here</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#get-the-latest-articles-in-your-inbox."><span class="toc-number">9.0.1.1.</span> <span class="toc-text">Get the latest articles in your inbox.</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/03/59cb1b4312ed.html" title="cppdoc"><img src="/img/cover/00000075.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="cppdoc"/></a><div class="content"><a class="title" href="/2024/03/59cb1b4312ed.html" title="cppdoc">cppdoc</a><time datetime="2024-03-14T13:13:29.240Z" title="Updated 2024-03-14 21:13:29">2024-03-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/f05961026253.html" title="数据结构"><img src="/img/cover/00000074.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="数据结构"/></a><div class="content"><a class="title" href="/2023/05/f05961026253.html" title="数据结构">数据结构</a><time datetime="2024-03-05T06:20:26.634Z" title="Updated 2024-03-05 14:20:26">2024-03-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/01/528ebafedd20.html" title="rfc笔记"><img src="/img/cover/32222.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="rfc笔记"/></a><div class="content"><a class="title" href="/2024/01/528ebafedd20.html" title="rfc笔记">rfc笔记</a><time datetime="2024-03-05T04:21:10.802Z" title="Updated 2024-03-05 12:21:10">2024-03-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/05/724d57ab8c34.html" title="操作系统"><img src="/img/cover/00000129.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="操作系统"/></a><div class="content"><a class="title" href="/2023/05/724d57ab8c34.html" title="操作系统">操作系统</a><time datetime="2024-03-05T03:24:13.030Z" title="Updated 2024-03-05 11:24:13">2024-03-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/08/625740ff980e.html" title="git-tips"><img src="/img/cover/00000179.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="git-tips"/></a><div class="content"><a class="title" href="/2023/08/625740ff980e.html" title="git-tips">git-tips</a><time datetime="2024-03-04T10:02:47.316Z" title="Updated 2024-03-04 18:02:47">2024-03-04</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Sinos</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container').forEach(node => {
            if (node.hasAttribute('display')) {
              btf.wrap(node, 'div', { class: 'mathjax-overflow' })
            } else {
              btf.wrap(node, 'span', { class: 'mathjax-overflow' })
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script></div><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>